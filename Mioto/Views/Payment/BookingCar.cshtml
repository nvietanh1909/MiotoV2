@model Mioto.Models.MD_BookingCar

@{
    ViewBag.Title = "Booking Car";
    Layout = "~/Views/Shared/_LayoutBase.cshtml";
    var khachhang = Session["KhachHang"] as Mioto.Models.KhachHang;
    var ngayTra = Session["EndDateTime"] as DateTime?;
    var ngayThue = Session["StartDateTime"] as DateTime?;

    if (ngayThue.HasValue)
    {
        Model.NgayThue = ngayThue.Value;
    }
    if (ngayTra.HasValue)
    {
        Model.NgayTra = ngayTra.Value;
    }
}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" rel="stylesheet" />
<link href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" rel="stylesheet" />
<link rel="stylesheet" href="~/zpgateway/css/bootstrap.min.css">
<link rel="stylesheet" href="~/zpgateway/css/blue.css">
<link href="~/Content/css/form_payment.css" rel="stylesheet" />
<script src="~/zpgateway//js/jquery.min.js"></script>
<script src="~/zpgateway//js/bootstrap.min.js"></script>
<script src="~/zpgateway//js/icheck.min.js"></script>
<script src="~/Scripts/Payment/main.js"></script>
<style>
    .icheckbox_flat-blue, .iradio_flat-blue {
        top: -2px;
        margin-right: 5px;
    }

    .txtGray {
        color: #798594;
    }
    a {
        color: black;
    }
        a:hover {
            color: inherit;
            background-color: inherit;
            text-decoration: none;
        }
    .header .m-container .menu-container a {
        font-weight: 500;
    }
    .header .m-container .menu-container .dropdown-profile .name {
        font-weight: 500;
    }
</style>
@using (Html.BeginForm("BookingCar", "Payment", FormMethod.Post, new { id = "bookingForm" }))
{
    @Html.AntiForgeryToken()
    <div class="container">
        <div class="row m-0">
            <div class="col-lg-7 pb-5 pe-lg-5">
                <div class="row">
                    <div class="col-12 p-5">
                        <img src="@Url.Content("~/CarImages/" + (Model.Xe.HinhAnh ?? "DefaultAvatar.jpg"))" alt="">
                        @Html.HiddenFor(model => model.Xe.HinhAnh)
                    </div>
                    <div class="row m-0 bg-light">
                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.Ten</p>
                        @Html.HiddenFor(model => model.KhachHang.Ten, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.HinhAnh</p>
                        @Html.HiddenFor(model => model.KhachHang.HinhAnh, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.Email</p>
                        @Html.HiddenFor(model => model.KhachHang.Email, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.IDKH</p>
                        @Html.HiddenFor(model => model.KhachHang.IDKH, new { style = "display:none;", id = "customerID" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.DiaChi</p>
                        @Html.HiddenFor(model => model.KhachHang.DiaChi, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.GPLX</p>
                        @Html.HiddenFor(model => model.KhachHang.GPLX, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.SDT</p>
                        @Html.HiddenFor(model => model.KhachHang.SDT, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@{Model.KhachHang.IDKH = khachhang.IDKH;}</p>
                        @Html.HiddenFor(model => model.KhachHang.IDKH, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.NgaySinh</p>
                        @Html.HiddenFor(model => model.KhachHang.NgaySinh, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.CCCD</p>
                        @Html.HiddenFor(model => model.KhachHang.CCCD, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.HinhAnh</p>
                        @Html.HiddenFor(model => model.KhachHang.HinhAnh, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.GioiTinh</p>
                        @Html.HiddenFor(model => model.KhachHang.GioiTinh, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.KhachHang.MatKhau</p>
                        @Html.HiddenFor(model => model.KhachHang.MatKhau, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.Xe.TrangThaiThue</p>
                        @Html.HiddenFor(model => model.Xe.TrangThaiThue, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.Xe.DonGiaVanChuyen</p>
                        @Html.HiddenFor(model => model.Xe.DonGiaVanChuyen, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.Xe.IDCX</p>
                        @Html.HiddenFor(model => model.Xe.IDCX, new { style = "display:none;" })

                        <p class="h5 m-0" style="display:none;">@Model.Xe.NamSX</p>
                        @Html.HiddenFor(model => model.Xe.NamSX, new { style = "display:none;" })

                        <div class="col-md-4 col-6 ps-30 my-4">
                            <p class="text-muted">Hãng Xe</p>
                            <p class="h5 m-0">@Model.Xe.HangXe</p>
                            @Html.HiddenFor(model => model.Xe.HangXe)
                        </div>
                        <div class="col-md-4 col-6 ps-30 my-4">
                            <p class="text-muted">Biển số</p>
                            <p class="h5 m-0" id="number_car">@Model.Xe.BienSo</p>
                            @Html.HiddenFor(model => model.Xe.BienSo)
                        </div>
                        <div class="col-md-4 col-6 ps-30 pe-0 my-4">
                            <p class="text-muted">Màu xe</p>
                            <p class="h5">@Model.Xe.Mau</p>
                            @Html.HiddenFor(model => model.Xe.Mau)
                        </div>

                        <div class="col-md-4 col-6 ps-30 my-4">
                            <p class="text-muted">Tính năng</p>
                            <p class="h5 m-0">@Model.Xe.TinhNang</p>
                            @Html.HiddenFor(model => model.Xe.TinhNang)
                        </div>
                        <div class="col-md-4 col-6 ps-30 my-4">
                            <p class="text-muted">Số ghế</p>
                            <p class="h5 m-0">@Model.Xe.SoGhe</p>
                            @Html.HiddenFor(model => model.Xe.SoGhe)
                        </div>
                        <div class="col-md-4 col-6 ps-30 my-4">
                            <p class="text-muted">Khu vực</p>
                            <p class="h5 m-0">@Model.Xe.KhuVuc</p>
                            @Html.HiddenFor(model => model.Xe.KhuVuc)
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-5 p-0 ps-lg-4">
                <div class="row m-0">
                    <div class="col-12 px-4">
                        <div class="d-flex align-items-end mt-4 mb-2">
                            <p class="h4 m-0">
                                <span class="pe-1">@Model.Xe.HangXe @Model.Xe.NamSX</span>
                            </p>
                        </div>

                        <div style="display:flex; justify-content: space-between">
                            <div class="form-group">
                                <strong>Ngày thuê</strong>
                                @Html.EditorFor(model => model.NgayThue, new { htmlAttributes = new { @class = "form-control", id = "NgayThue", type = "datetime-local" } })
                                @Html.ValidationMessageFor(model => model.NgayThue, "", new { @class = "text-danger" })
                            </div>

                            <div class="form-group">
                                <strong>Ngày trả</strong>
                                @Html.EditorFor(model => model.NgayTra, new { htmlAttributes = new { @class = "form-control", id = "NgayTra", type = "datetime-local" } })
                                @Html.ValidationMessageFor(model => model.NgayTra, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div id="alert-error" style="color:red;"></div>
                        <div class="d-flex justify-content-between mb-2">
                            <p class="textmuted">Giá tiền thuê/ ngày:</p>
                            <p class="fs-14">@String.Format("{0:N0} VND", Model.Xe.GiaThue)</p>
                            @Html.HiddenFor(model => model.Xe.GiaThue)
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <p class="textmuted">Giảm giá:</p>
                            <p class="fs-14" id="percent_discount"></p>
                        </div>

                        <div class="d-flex justify-content-between mb-2">
                            <p class="textmuted">Số lượng ngày thuê:</p>
                            <p class="fs-14" id="number_day_rented"></p>
                        </div>

                        <div class="d-flex justify-content-between mb-3">
                            <label for="totalAmount" class="textmuted">Tổng tiền:</label>
                            <span id="GiaThue">0 VNĐ</span>
                            @Html.HiddenFor(model => model.TongTien)
                        </div>
                    </div>

                    <div class="form-group">
                        @Html.LabelFor(model => model.MaGiamGia.MaGG, "Mã giảm giá")
                        @Html.TextBoxFor(model => model.MaGiamGia.MaGG, new { @class = "form-control", placeholder = "Nhập mã giảm giá", id = "discountCode" })
                        <button type="button" class="btn btn-secondary" id="applyDiscount">Áp dụng mã giảm giá</button>
                    </div>

                    <div class="col-12 px-0">
                        <button type="submit" class="btn btn-primary" id="btn-success" style="margin-top: 20px;">Thanh toán<span class="fas fa-arrow-right ps-2"></span></button>

                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script type="text/javascript">
       $(document).ready(function () {
    function calculatePrice() {
        var ngayThue = $('#NgayThue').val();
        var ngayTra = $('#NgayTra').val();
        var rangeNgayThue = new Date('@Session["StartDateTime"]'); // Ngày thuê từ Session
        var rangeNgayTra = new Date('@Session["EndDateTime"]');
        var currentDate = new Date(); // Ngày hiện tại
      
        if (ngayThue) {
            var startDate = new Date(ngayThue);
            if (startDate < currentDate) {
                $('#alert-error').text('Ngày thuê không thể nhỏ hơn ngày hiện tại');
                return;
            }
        }

        if (ngayThue && ngayTra) {
            var startDate = new Date(ngayThue); // Chú ý định dạng nhập vào là yyyy-MM-ddTHH:mm:ss
            var endDate = new Date(ngayTra);

            if (startDate < rangeNgayThue || endDate > rangeNgayTra) {
                var formattedRangeNgayThue = rangeNgayThue.toLocaleString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                var formattedRangeNgayTra = rangeNgayTra.toLocaleString('vi-VN', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                $('#alert-error').text('Ngày thuê và ngày trả phải nằm trong khoảng: ' + formattedRangeNgayThue + ' - ' + formattedRangeNgayTra);
                return;
            }

            var timeDifference = endDate - startDate;

            var hours = timeDifference / (1000 * 60 * 60); // Tổng số giờ thuê
            var days = Math.ceil(hours / 24); // Số ngày thuê
            var giaThuePerDay = @Model.Xe.GiaThue; // Giá thuê mỗi ngày từ model
            var totalPrice = giaThuePerDay * days; // Tổng giá thuê

            if (timeDifference > 0) {
                $('#number_day_rented').text(days);
                $('#alert-error').text(""); 
                $('#GiaThue').text(totalPrice.toLocaleString('vi-VN') + ' VNĐ');
                $('input[name="TongTien"]').val(totalPrice);
                $('input[name="SoTien"]').val(totalPrice);
            } else {
                $('#alert-error').text('Ngày trả phải sau ngày thuê');
            }
        }
    }

    // Khi ngày thuê hoặc ngày trả thay đổi, tính lại giá thuê
    $('#NgayThue, #NgayTra').on('change', function () {
        calculatePrice();
    });
});


    $('#applyDiscount').click(function () {
        var discountCode = $('#discountCode').val();
        var totalPrice = parseInt($('#GiaThue').text().replace(/\D/g, ''), 10);

        if (discountCode) {
            $.ajax({
                url: '@Url.Action("ApplyDiscount", "Payment")',
                type: 'POST',
                data: { discountCode: discountCode, totalPrice: totalPrice },
                success: function (data) {
                    if (data.success) {
                        var discountedPrice = data.newTotalPrice;
                        var discountPercentage = data.discount; 

                        $('#GiaThue').text(discountedPrice.toLocaleString('vi-VN') + ' VNĐ');
                        $('input[name="SoTien"]').val(discountedPrice);
                        $('input[name="TongTien"]').val(discountedPrice);
                        $('#percent_discount').text(discountPercentage + '%');
                    } else {
                        alert('Mã giảm giá không hợp lệ!');
                    }
                },
                error: function () {
                    alert('Có lỗi xảy ra, vui lòng thử lại!');
                }
            });
        } else {
            alert('Vui lòng nhập mã giảm giá!');
        }
    });
    </script>
}